###############################################################################
# Dockerfile used to make gitlab.linphone.org:4567/bc/public/flexisip/bc-dev-debian11:20230512_use_cmake_3.22
###############################################################################

FROM gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-debian11:20230420_use_cmake_3.22

MAINTAINER Anthony Gauchy <anthony.gauchy@belledonne-communications.com>

# Add extra dependencies for Flexisip and clang test coverage
RUN sudo su -c 'apt-get -y --allow-releaseinfo-change update && \
  apt-get -y install \
    libboost-dev libboost-system-dev libboost-thread-dev \
    libhiredis-dev \
    libjansson-dev \
    libjsoncpp-dev \
    libmariadb-dev-compat \
    libnghttp2-dev \
    libprotobuf-dev \
    libsnmp-dev \
    llvm \
    mariadb-server \
    protobuf-compiler \
    redis-server \
    wget && \
  apt-get -y clean'

# Install libnghttp2_asio
RUN wget https://github.com/nghttp2/nghttp2/releases/download/v1.43.0/nghttp2-1.43.0.tar.bz2 && \
	tar xf nghttp2-1.43.0.tar.bz2 && \
	cd nghttp2-1.43.0 && \
	./configure --prefix=/usr/local --disable-examples --disable-python-bindings --enable-lib-only --enable-asio-lib && \
	make && \
	sudo make -C src install && \
	cd - && \
	rm -rf nghttp2-1.43.0.tar.bz2 nghttp2-1.43.0

# Dependency of clang test coverage (converts lcov format to cobertura so Gitlab can display code coverage for files in diff view)
RUN pip install lcov_cobertura

# CVE-2022-24765, from git 2.35.2 onward
RUN git config --global --add safe.directory *
