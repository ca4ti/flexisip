###############################################################################
# Dockerfile used to make gitlab.linphone.org:4567/bc/public/flexisip/bc-dev-centos7:20230513_use_cmake_3.22
###############################################################################

FROM gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-centos7:20230420_use_cmake_3.22

MAINTAINER Anthony Gauchy <anthony.gauchy@belledonne-communications.com>

# Install common general tools
RUN sudo yum install -y vim wget

# Update
RUN sudo yum makecache && sudo yum -y update

 # Install development tools
RUN sudo yum -y install \
	bzip2 \
	c-ares-devel \
	libev-devel \
	zlib-devel \
	libuv-devel \
	devtoolset-8-libasan-devel \
	devtoolset-8-libubsan-devel \
	llvm \
	# Install all dependencies needed for Flexisip
	openssl-devel \
	boost169-devel \
	hiredis-devel \
	jansson-devel \
	libsqlite3x-devel \
	mariadb-devel \
	mariadb-server \
	postgresql-devel \
	nghttp2 \
	libnghttp2-devel \
	protobuf-devel \
	net-snmp-devel \
	xerces-c-devel \
	gsm-devel \
	opus-devel \
	mbedtls-devel \
	speex-devel \
	speexdsp-devel \
	libxml2-devel \
	protobuf-compiler \
	redis \
	# Dependencies of the B2BUA
	jsoncpp-devel \
	&& sudo yum -y clean all \
	&& sudo scl enable devtoolset-8 bash

# Install libnghttp2_asio 1.30.0
COPY libnghttp2_asio_install.sh .
RUN source /opt/rh/devtoolset-8/enable \
    && export CC=gcc && export CXX=g++ \
    && export BOOST_INCLUDEDIR=/usr/include/boost169 && export BOOST_LIBRARYDIR=/usr/lib64/boost169 \
    && sudo ./libnghttp2_asio_install.sh 1.30.0 && rm libnghttp2_asio_install.sh

# CVE-2022-24765, from git 2.35.2 onward
RUN git config --global --add safe.directory *


# Example build commands
#
# export CC=gcc
# export CXX=g++
# export BUILD_DIR_NAME="build.centos7"
# source /opt/rh/devtoolset-8/enable
# cmake -S . -B ./$BUILD_DIR_NAME -G "Ninja" -DCMAKE_BUILD_TYPE=Sanitizer -DCMAKE_INSTALL_PREFIX="$PWD/$BUILD_DIR_NAME/install" -DINTERNAL_LIBHIREDIS=ON -DINTERNAL_JSONCPP=ON -DBOOST_INCLUDEDIR=/usr/include/boost169 -DBOOST_LIBRARYDIR=/usr/lib64/boost169 -DENABLE_UNIT_TESTS=ON -DCMAKE_INSTALL_RPATH_USE_LINK_PATH=ON
# cmake --build . --target install
